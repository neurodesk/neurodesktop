#!/bin/bash
# Claude Code wrapper script
# Copies ~/AGENTS.md and settings.local.json to current directory, then starts Claude Code

is_apptainer_runtime() {
    [ -n "${SINGULARITY_NAME:-}" ] || \
    [ -n "${APPTAINER_NAME:-}" ] || \
    [ -n "${APPTAINER_CONTAINER:-}" ] || \
    [ -n "${SINGULARITY_CONTAINER:-}" ] || \
    [ -n "${APPTAINER_COMMAND:-}" ] || \
    [ -n "${SINGULARITY_COMMAND:-}" ] || \
    [ -d "/.apptainer.d" ] || \
    [ -d "/.singularity.d" ]
}

# Copy AGENTS.md from home directory to current directory as CLAUDE.md
if [ ! -f ./CLAUDE.md ]; then
    cp /opt/AGENTS.md ./CLAUDE.md
fi

# Copy settings.local.json from home directory to current directory's .claude folder
if [ ! -f ./.claude/settings.local.json ]; then
    mkdir -p ./.claude
    cp /opt/jovyan_defaults/.claude/settings.local.json ./.claude/settings.local.json    
fi


# Start Claude Code from the standard user-local path.
CLAUDE_BIN="${HOME}/.local/bin/claude"
DEFAULT_CLAUDE_BIN="/opt/jovyan_defaults/.local/bin/claude"

if [ ! -x "${CLAUDE_BIN}" ] && [ -x "${DEFAULT_CLAUDE_BIN}" ]; then
    mkdir -p "${HOME}/.local/bin" 2>/dev/null || true
    cp -p "${DEFAULT_CLAUDE_BIN}" "${CLAUDE_BIN}" 2>/dev/null || true
fi

if [ ! -x "${CLAUDE_BIN}" ]; then
    echo "Claude binary not found at ${CLAUDE_BIN}. Restore from ${DEFAULT_CLAUDE_BIN} also failed." >&2
    exit 127
fi

extra_args=()
has_mcp_config_arg=0
has_strict_mcp_config_arg=0

for arg in "$@"; do
    case "$arg" in
        --mcp-config|--mcp-config=*)
            has_mcp_config_arg=1
            ;;
        --strict-mcp-config)
            has_strict_mcp_config_arg=1
            ;;
    esac
done

if is_apptainer_runtime; then
    if [ "${has_strict_mcp_config_arg}" -eq 0 ]; then
        extra_args+=(--strict-mcp-config)
    fi
    if [ "${has_mcp_config_arg}" -eq 0 ]; then
        extra_args+=(--mcp-config '{}')
    fi
fi

exec "${CLAUDE_BIN}" --allow-dangerously-skip-permissions "${extra_args[@]}" "$@"
