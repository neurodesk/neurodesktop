#!/bin/bash
# OpenAI Codex CLI wrapper script
# Copies AGENTS.md to current directory as AGENTS.md, then starts Codex CLI

# Copy AGENTS.md from /opt to current directory as AGENTS.md (Codex uses AGENTS.md)
if [ ! -f ./AGENTS.md ]; then
    cp /opt/AGENTS.md ./AGENTS.md
fi

# Copy codex config from home directory to current directory's .codex folder
if [ ! -f ./.codex/config.json ]; then
    mkdir -p ./.codex
    cp /opt/jovyan_defaults/.codex/config.json ./.codex/config.json
fi

# In browser-proxied environments (e.g., code-server behind Jupyter),
# localhost OAuth callbacks can fail. Default `codex login` to device auth
# unless the caller already requested an explicit auth mode.
if [ "${1:-}" = "login" ]; then
    shift
    for arg in "$@"; do
        if [ "$arg" = "--device-auth" ] || [ "$arg" = "--with-api-key" ]; then
            exec /usr/bin/codex login "$@"
        fi
    done
    exec /usr/bin/codex login --device-auth "$@"
fi

# Start Codex CLI using the actual binary path (not this wrapper)
exec /usr/bin/codex --full-auto "$@"
